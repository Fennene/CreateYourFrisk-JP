<!DOCTYPE html>
<!--
since you're here anyway: there's a small easter egg on the text commands page but it's probably not worth finding, sorry
you may notice this page's code is garbage: i'm not a web designer! ;-;
it's w3c valid, at least
-->

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>CYF ドキュメント - ゲームイベント</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="../css/themesidebar.css" rel="stylesheet">
    <link href="../css/shThemeRDark.css" rel="stylesheet">

    <!-- Syntax highlighting -->
    <script type="text/javascript" src="../js/shCore.js"></script>
    <script type="text/javascript" src="../js/shBrushLua.js"></script>
    <script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body>
<img src="../img/bg2.png" alt="Undertale background" class="backimg">
<div class="container arena black">
    <div class="col-md-2">
        <!--navigation-->
        <nav class="nav-sidebar">
            <ul class="nav tabs">
                <li class="li-header">基本</li>
                    <li><a href="../documentation.html">ようこそ</a></li>
                    <li><a href="howtoread.html">このドキュメントの読み方</a></li>
                    <hr style="margin-top:-2.5px;margin-bottom:2.5px;">
                    <li><a href="controls.html">操作方法</a></li>
                    <li><a href="basic.html">基本構成</a></li>
                    <li><a href="unity.html"><span class="CYF"></span> Unity Setup (Optional)</a></li>
                    <li><a href="variables.html">予約変数</a></li>
                    <li><a href="terms.html">用語</a></li>
                <li class="li-header">API</li>
                    <li><a href="api-text.html">テキストコマンド</a></li>
                    <li class="active new" style="margin-left:5px;">&gt; ゲームイベント &lt;</li>
                    <hr style="margin-top:-2.5px;margin-bottom:2.5px;">
                    <li class="li-indent">関数 &amp; オブジェクト:</li>
                        <li class="li-indent new"><a href="api-functions-main.html">その他の関数</a></li>
                        <li class="li-indent new"><a href="api-functions-player.html">Player オブジェクト</a></li>
                        <li class="li-indent"><a href="api-functions-script.html">Script オブジェクト</a></li>
                        <li class="li-indent"><a href="api-functions-audio.html">Audio オブジェクト</a></li>
                        <li class="li-indent"><a href="api-functions-newaudio.html"><span class="CYF"></span> NewAudio オブジェクト</a></li>
                        <li class="li-indent"><a href="api-functions-input.html">Input オブジェクト</a></li>
                        <li class="li-indent"><a href="api-functions-time.html">Time オブジェクト</a></li>
                        <li class="li-indent"><a href="cyf-inventory.html"><span class="CYF"></span> Inventory オブジェクト</a></li>
                        <li class="li-indent new"><a href="api-functions-misc.html"><span class="CYF"></span>Misc オブジェクト</a></li>
                        <li class="li-indent new"><a href="api-functions-discord.html"><span class="CYF"></span> The Discord Object</a></li>
                        <li class="li-indent"><a href="api-functions-waves.html">Arena オブジェクト</a></li>
                    <hr style="margin-top:-2.5px;margin-bottom:2.5px;">
                    <li><a href="api-projectile.html">発射体(Projectile) 制御</a></li>
                    <li><a href="cyf-ppcollision.html"><span class="CYF"></span> The Pixel-Perfect Collision システム</a></li>
                    <li class="new"><a href="api-animation.html">スプライト &amp; アニメーション</a></li>
                    <li class="new"><a href="cyf-text.html"><span class="CYF"></span> Text オブジェクト</a></li>
                    <hr style="margin-top:-2.5px;margin-bottom:2.5px;">
                <li class="li-header"></span><span class="CYF"></span> <span class="new"></span>Shaders</li>
                    <li><a href="shaders.html">Introduction</a></li>
                    <li><a href="shaders-object.html">The Shader Object</a></li>
                    <li><a href="shaders-coding.html">Coding a Shader</a></li>
                    <hr style="margin-top:10px;margin-bottom:10px;">
                <li class="li-header"><span class="CYF"></span> Overworld</li>
                    <li class="new"><a href="overworld.html">Basics</a></li>
                    <li><a href="overworld-howto-map.html">How to create a map</a></li>
                    <li><a href="overworld-howto-event.html">How to create an event</a></li>
                    <li><a href="overworld-howto-animevent.html">How to animate an event</a></li>
                    <li class="new"><a href="overworld-howto-shop.html">How to create a shop</a></li>
                    <hr style="margin-top:-2.5px;margin-bottom:2.5px;">
                    <li class="li-indent"><span class="CYF"></span> Overworld Objects:</li>
                        <li class="li-indent"><a href="overworld-object-general.html">The General Object</a></li>
                        <li class="li-indent"><a href="overworld-object-event.html">The Event Object</a></li>
                        <li class="li-indent"><a href="overworld-object-player.html">The Player Object</a></li>
                        <li class="li-indent"><a href="overworld-object-screen.html">The Screen Object</a></li>
                        <li class="li-indent"><a href="overworld-object-inventory.html">The Inventory Object</a></li>
                        <li class="li-indent new"><a href="overworld-object-map.html">The Map Object</a></li>
                    <hr style="margin-top:-2.5px;margin-bottom:2.5px;">
                <li class="li-header">素材</li>
                    <li><a href="../media/dialogoptions.png">吹き出し一覧</a></li>
                    <li><a href="api-keys.html"><span class="CYF"></span> キーリスト</a></li>
            </ul>
        </nav>
    </div>
    <!--tabs'n'shit-->
    <div class="tab-content col-md-10">
        <div class="tab-pane active text-style" id="api-events">
            <h2>ゲームイベント</h2><br><br>
            <p>このセクションでは、全てのゲームイベントについて説明します。 
                ゲームイベントは、Unitaleエンジンがゲーム中で呼び出す様々な関数です。
                プレイヤーの選択に合わせて、各イベントを駆使してゲームの制御を行えます。</p>
            <!--
            <hr>
            <h3>Inherited events (Encounter -> Monster)</h3><br><br>
            <p>
                An <span class="term">inherited event</span> is a function that gets run first on your Encounter script. If the
                function is not found in the Encounter script, it will try to run the same function on all monsters. If
                it's not found there either, it will resort to a default, built-in handler.
            </p>
            -->
            <br>
            <hr>
            <h3>スクリプト固有イベント</h3><br><br>
            <p>
                <i>スクリプト固有イベント</i>はその名の通り、特定のスクリプトで使用できるイベントです。
            </p>
            <br>
            <h4>エンカウンタースクリプトのイベント</h4>
            <p>
                <br><span class="function">EncounterStarting()</span>
                エンジンの初期化が終了した際に、ゲームが開始する直前に１回だけ呼び出されます。
                音楽を停止したり、相手のターンからゲームを開始したい時などは、<span class="term">Audio.Stop()</span>や<span class="term">State()</span>などをここで使用します。
            </p>
            <p>
                <br><span class="function">EnemyDialogueStarting()</span>
                モンスターが会話をする直前に呼び出されます。ここでモンスターの会話を自由に変更することができます。
            </p>
            <p>
                <br><span class="function">EnemyDialogueEnding()</span>
                モンスターの会話が終了し、敵の攻撃が開始する直前に呼び出されます。
            </p>
            <p>
                <br><span class="function">DefenseEnding()</span>
                モンスターの攻撃が終了直後に呼び出されます。 
                <span class="term">RandomEncounterText()</span>関数はここで使用することをお勧めします。
            </p>
            <p>
                <br><span class="function">HandleSpare()</span>
                モンスターが見逃せるかどうかに関係なく、MERCYから にがす(Spare)を選ぶと呼び出されます。
                このイベントはモンスタースクリプトのSpare()が終了した<i>後に</i>呼び出されます。[翻訳要検証]
                最後の敵を見逃した場合、この関数は呼び出されることなく、ゲームは終了します。
                <strike>本当に...? by 翻訳者</strike>
            </p>
            <p>
                <br><span class="function">HandleItem(<span class="string"></span> item_ID, <span class="number"></span> position)</span>
                ITEMから何かしらのアイテムを選択すると呼び出されます。
                <ul>
                    <li><span class="term">item_ID</span>: アイテムの名前が<b><u>全て大文字で</u></b>代入されます。
                    モンスタースクリプトの<span class="term">HandleCustomCommand</span>と似ています。</li>
                    <li><span class="term">position</span>: プレイヤーの選択したアイテムの位置。インベントリの最初は１です。</li>
                </ul>
                <br><span class="CYF"></span> CYFではInventoryオブジェクトを使用して、プレイヤーのインベントリを編集できます。
                アイテム名は<span class="term">HandleCustomCommand()</span>のように大文字になります。
                <div class="code-container">
  <pre class="brush:lua;">function HandleItem(ItemID, position)
    if ItemID == "DOGTEST2" then
        BattleDialog({"You selected The Second Dog.", "You are truly great."})
        --BattleDialog({"あなたは２つ目のイヌを選んだ。", "本当に最高だよ、君。"})
    else
        BattleDialog({"You didn't select The Second Dog.", "You could've picked better."})
        --BattleDialog({"あなたは２つ目のイヌを選ばなかった。", "もっといい選択ができただろう？"})
    end
    DEBUG("You chose item #" .. position .. " in your inventory.")
    --DEBUG("インベントリ内の#" .. position .. "番目のアイテムを選択しました。")
end
</pre>
            </div>
            </p>
            <p>
                <br><span class="function">EnteringState(<span class="string"></span> newstate, <span class="string"></span>  oldstate)</span>
                ゲームの状態が変化すると呼び出されます。上記のイベントよりも細かく条件を指定できます。
                状態が変化すると、変化した後(新しく変わる状態)の名前を<span class="term">newstate</span>に、変化する前の古い状態を<span class="term">oldstate</span>に代入されて呼び出されます。
                引数の中身はは大文字です。この関数の最も強力な点の１つは<span class="term">State()</span>を使用して、
                戦闘の流れを強制的に中断して、変更できるところです。
                <br>
                <br>考えられる状態(とその実行時期は[翻訳力不足])以下の通り:
            </p>
            <ul>
                <li><span class="term">ACTIONSELECT</span> - プレイヤーのターンを表します。プレイヤーは FIGHT/ACT/ITEM/MERCY を選択できます。
                </li><br>
                <li><span class="term">ATTACKING</span> - プレイヤーがFIGHTを選択し、攻撃する敵を決めて、攻撃する時を表します。</li><br>
                <li><span class="term">DEFENDING</span> - 敵のターンを表します。敵の会話が終了し敵が攻撃し、プレイヤーが避ける時です。</li><br>
                <li><span class="term">ENEMYSELECT</span> - プレイヤーがFIGHTまたはACTを選択し、敵を選択する時を表します。</li><br>
                <li><span class="term">ACTMENU</span> - プレイヤーがACTを選択し、敵を選択し、行動を選んでいる時を表します。</li><br>
                <li><span class="term">ITEMMENU</span> - プレイヤーがITEMを選択した時を表します。</li><br>
                <li><span class="term">MERCYMENU</span> - プレイヤーがMERCYを選択した時を表します。</li><br>
                <li><span class="term">ENEMYDIALOGUE</span> - 敵の会話中を表します。</li><br>
                <li><span class="term">DIALOGRESULT</span> - <span class="term">BattleDialog()</span>を呼び出した時や、ダイアログボックス(アリーナ)内にテキストを表示している時を表します。
                (例えばアイテムを選択した後)
                </li><br>
            </ul>
            注: ここで言及されていない３つの状態が存在します。それらは、自然と発生することが無いからです。[翻訳力不足]それらは<span class="ref">関数 &amp;
            オブジェクト</span>で確認できます。
            <br><br>For a clearer example, here's a code snippet replicating the older events above.
            <div class="code-container">
<pre class="brush:lua;">function EnteringState(newstate, oldstate)
    if newstate == "ENEMYDIALOGUE" then
        --EnemyDialogueStarting()と同じ意味
    elseif newstate!= "ENEMYDIALOGUE" and oldstate == "ENEMYDIALOGUE" then
        --EnemyDialogueEnding()または newstate == "DEFENDING" と同じ
    elseif newstate!= "DEFENDING" and oldstate == "DEFENDING" then
        --DefenseEnding()と同じ意味
    end
end
</pre>
            </div>
            <p>
                <br><span class="function">Update()</span>
                この関数は例え敵のターン中であろうと、ゲーム中毎フレーム(通常は60fpsで、プレイヤーのフレームレートで少し異なる場合があります)呼び出されます。
                これはいつ、どんな場合でも実行できる強力な関数です。
                唯一の例外として、プレイヤーがゲームオーバーとなった場合です。
                プレイヤーが死亡した場合は、この関数内のコードは実行されません。
            </p>
            <p>
                <br><span class="function"><span class="CYF"> </span>BeforeDeath()</span>
                これはプレイヤーがゲームオーバーになる直前に呼び出されます。
                (これは、弾丸(発射体(Projectile))によるダメージやスクリプトでのダメージ、
                <span class="term">Player.hp</span>を <span class="term">0</span>にすることによる死、テキストコマンドによるダメージなど
                どんな原因であろうと呼び出されます。)This is the perfect place to set Real
                and AlMighty Globals you want set when the player dies<br>(see <span class="ref">Misc. Functions</span>).
                <br><br>
                <span class="term">Player.hp</span>や<span class="term">Player.Heal</span>を使用して、プレイヤーのHPを 0より大きくした場合、
                ゲームオーバーはキャンセルされます。
            </p>
            <br><br>
            <hr>
            <h4>モンスタースクリプトのイベント</h4>
            <p>
                <br><span class="function">HandleAttack(<span class="number"></span> damage)</span>
                プレイヤーが攻撃し、ダメージを受けた瞬間(敵のダメージ音が聞こえた時)に呼び出されます。<br>
                プレイヤーがFIGHTを選択したが、攻撃しなかった場合は<span class="term">damage</span>が -1になります。
                モンスターの<span class="term">hp</span>変数もこの時点で更新されます。
                <br>ここで<span class="term">BattleDialog()</span>を呼び出さないでください。バグが発生します。
            </p>
            <p>
                <br><span class="function">OnDeath()</span>
                モンスターのダメージのアニメーションが終了し、モンスターのHPが０になった後に呼び出されます。
                モンスタースクリプトに<span class="term">OnDeath()</span>を実装すると、モンスターは自動的に死ななくなります。
                倒すには手動で<span class="term">Kill()</span>関数を呼び出す必要があります。
                <br><br>
                <span class="term">OnDeath()</span>はプレイヤーがFIGHTを選んで攻撃して倒したときにのみ呼び出されます。
                コードで<span class="term">Kill()</span>を使用して倒した場合は呼び出されません。
                <br><span class="term">BattleDialog()</span>をここで使うとUIがぶっ壊れるそうで。
            </p>
            <p>
                <br><span class="function"><span class="CYF"> </span>OnSpare()</span>
                プレイヤーがモンスターを逃がしたとき(成功時)に呼び出されます。
                モンスタースクリプトに<span class="term">OnSpare()</span>を実装すると、モンスターは自動的に見逃されずにとどまります。
                完璧に見逃すには、手動で<span class="term">Spare()</span>関数を呼び出す必要があります。
                <br><br>
                <span class="term">OnSpare()</span>はプレイヤーががMERCYを選んで見逃した場合にのみ呼び出されます。
                コードで<span class="term">Spare()</span>を使用して見逃した場合は呼び出されません。
            </p>
            <p>
                <br><span class="function"><span class="CYF"> </span>BeforeDamageCalculation()</span>
                プレイヤーの攻撃時にZを押して、モンスターのダメージの計算直前に呼び出されます。
                この関数では<span class="term">SetDamage()</span>を使用できます。
                回避アニメーションを始めるにもちょうどいい関数です。
            </p>
            <p>
                <br><span class="function"><span class="CYF"> </span>BeforeDamageValues(<span class="new"></span><span class="number"></span> damage)</span>
                モンスターにダメージのUI(HPバーとダメージ値の表示)が表示される直前、及びモンスターのHPが変化する直前に呼び出されます。
                この関数で<span class="term">Player.ChangeTarget(targetNumber)</span>を使用して、攻撃するターゲットは変更できますが、
                <span class="term">SetDamage</span>を使用することは<i>できません</i>。
                <br><br>
                <span class="new"></span> 引数の<span class="term">damage</span>はモンスターが受けるダメージを表します。
                <br><span class="term">HandleAttack</span>とは異なり、モンスターがこのダメージを受けて<u>いない</u>事に注意してください。
            </p>
            <p>
                <br><span class="function">HandleCustomCommand(<span class="string"></span> command)</span>
                ACTコマンドでこのモンスターが選ばれると呼び出されます。<span class="term">command</span>は<b><u>全て大文字になる</u></b>ことを除いて
                <span class="term">commands</span>配列で定義したものです。以下はIntermediate例であり、
                showing how you can use it and spice it up a little.
            </p>
            <div class="code-container">
  <pre class="brush:lua;">commands = {"Sing", "Dance", "Wiggle"} --スクリプトの先頭にどこか
wigglecounter = 0 --let's keep a counter to check how often we've wiggled

function HandleCustomCommand(command)
    if command == "SING" then
        BattleDialog({"You sing your heart out. It's in the arena now."})
    elseif command == "DANCE" then
        BattleDialog({"You busted out your best moves."})
    elseif command == "WIGGLE" then
        if wigglecounter == 0 then --you can use variables to make commands more exciting!
            BattleDialog({"You just kind of stood there and wiggled."})
        elseif wigglecounter == 1 then
            BattleDialog({"You're still kind of standing there and wiggling."})
        else
            BattleDialog({"Your wiggled so often that your wiggling technique\ris now legendary."})
        end
        wigglecounter = wigglecounter + 1 --be sure to increase the wiggle counter, or it'll stay at 0
    end
end
</pre>
            </div>
            <br>
            <hr>
            <h4>ウェーブスクリプトのイベント</h4>
            <p>
                <br><span class="function">Update()</span>
                この関数は敵のターン中、毎フレーム(通常は60fps)呼び出されます。
                <br><br>
                That's pretty much it.
                ここで弾丸(発射体(Projectile))の制御を行います。
                弾丸(発射体(Projectile))の作成と制御は
                <span class="ref">API - 発射体(Projectile) 制御</span>を参照してください。
            </p>
            <p>
                <br><span class="function"><span class="CYF"> </span>EndingWave()</span>
                この関数はウェーブ(敵のターン)が終了する直前に呼び出されます。
                いくつかの変数などをリセットするのに向いています。
            </p>
            <hr>
            <h3>全てのスクリプトで使用可能なイベント</h3><br><br>
            <p>
                エンカウンター、モンスター、ウェーブなど、あらゆるスクリプトで使用できるイベントです。
            </p>
            <br>
            <p>
                <br><span class="function">OnHit(<span class="userdata">bullet</span> bullet)</span>
                プレイヤーが弾丸(発射体(Projectile))と衝突する度に呼び出されます。
                この関数は、弾丸が作成されたスクリプトで、呼び出されます。
                (受けた弾丸が、ウェーブで作成されたものの場合は、ウェーブのOnHitが呼び出され、エンカウンターで作成された物の場合は、エンカウンターのOnHitが呼び出されます。[要検証])
                必要に応じて、受けた弾丸を変更する(制御する)ことができます。
                弾丸(発射体(Projectile))の制御は<span class="ref">Projectile Management</span>を参照してください。<br>
                <br>
                この関数を実装すると、弾丸と衝突した後に起こる挙動を、手動で実装する必要があります。
                これで、青(シアン)色、オレンジ色、緑色の弾丸(の挙動)を作成することができます。
                この関数を実装しない場合、プレイヤーは弾丸と衝突するたびに３ダメージを受けます。
                <!-- Below are multiple examples of how to use this function. -->
            </p>
            <p>
                <br><span class="function new">OnTextAdvance(<span class="userdata">text</span> text, <span class="boolean"></span> final)</span>
                Every time a <span class="ref">Text Object</span> automatically advances to the next line of text (that's
                by any means <i>except</i> <span class="term">Text.NextLine()</span>), this function gets called in the
                script that created the text object. This function is the best place to manipulate the letters from
                <span class="term">Text.GetLetters</span>.
                <br><br>
                <span class="term">text</span> is the text object in question, while <span class="term">final</span> is
                true only if the text object just advanced past its last line and deleted itself now that it's finished.
                <br><br>
                Text objects have a one-frame delay by default - see <span class="term">CreateText</span> in
                <span class="ref">The Text Object</span>. If the text object is using this delay, then this function will
                additionally be called on the first frame it starts to type (so one frame after it gets created). But if
                you disable the one-frame delay, this function will <i>not</i> be called for the first line of text, since
                you would already be able to access <span class="term">Text.GetLetters</span> and similar properties right
                after calling <span class="term">CreateText</span>.
            </p>
        </div>

        <div class="tab-pane text-style" id="mercy">
            <h2 style="text-decoration: none; line-height:50px;">
                * YOU WON!<br>
                * You earned 0 EXP and 0 gold.<br>
                * also the nav menu is broken now
            </h2><br>
        </div>

    </div>
</div>

<div class="container">
    <div class="col-xs-3"><img class="centerbt black" alt="Undertale fake button" src="../img/fightbt_0.png" height="42">
    </div>
    <div class="col-xs-3"><img class="centerbt black" alt="Undertale fake button" src="../img/actbt_0.png" height="42">
    </div>
    <div class="col-xs-3"><img class="centerbt black" alt="Undertale fake button" src="../img/itembt_0.png" height="42">
    </div>
    <div class="col-xs-3"><a href="#mercy" data-toggle="tab"><img class="centerbt black" alt="Undertale fake button"
                                                                  src="../img/mercybt_0.png" height="42"></a>
    </div>
</div>
<br>
<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/show_hide_comments.js"></script>

<script type="text/javascript" src="../js/FontToggleButton.js"></script>
</body>
</html>